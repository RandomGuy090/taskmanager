/*quick setup*/
create view main_page_info as
SELECT
taskmanager_user.name as user,
taskmanager_user.profImg as prof_pic,
taskmanager_tables.id as table_id,
taskmanager_tables.name as table_name,
taskmanager_tables.url as table_url,
taskmanager_tables.color as table_color,
taskmanager_tables.borderColor as table_b_color
FROM
taskmanager_particip
LEFT JOIN taskmanager_user ON taskmanager_particip.userId_id = taskmanager_user.id
LEFT JOIN taskmanager_tables ON taskmanager_particip.tableId_id = taskmanager_tables.id;
;

CREATE VIEW list_users_table as
SELECT 
taskmanager_particip.joinedDate as date,
taskmanager_user.id as user_id,
taskmanager_user.name as user_name,
taskmanager_user.profImg as user_prof,
taskmanager_taskcolor.color as user_color,
taskmanager_tables.id as table_id,
taskmanager_tables.url as table_url,
taskmanager_tables.name as table_name,
taskmanager_tables.color as table_color
FROM
taskmanager_particip
JOIN taskmanager_user ON taskmanager_particip.userId_id = user_id
JOIN taskmanager_tables ON taskmanager_particip.tableId_id = table_id
JOIN taskmanager_taskcolor ON taskmanager_taskcolor.userId_id = user_id
;


create view get_tasks as
select  
taskmanager_tables.name as table_name,
taskmanager_user.name as user,
taskmanager_user.id as user_id,
taskmanager_user.profImg as user_prof_pic,
taskmanager_tables.color as table_color,
taskmanager_taskcolor.color as task_color,
taskmanager_tables.url as table_url,
taskmanager_notes.tableNote as note,
taskmanager_notes.addedDate as added_date,
taskmanager_notes.todoDate as to_do_date,
taskmanager_notes.id as note_id

from 
taskmanager_notes
JOIN taskmanager_user ON taskmanager_notes.userId_id = taskmanager_user.id
JOIN taskmanager_tables ON taskmanager_notes.tableId_id = taskmanager_tables.id
JOIN taskmanager_taskcolor ON taskmanager_notes.userId_id = taskmanager_taskcolor.userId_id AND taskmanager_notes.tableId_id = taskmanager_taskcolor.tableId_id


create view get_table_color as
select 
taskmanager_user.name as user_name, 
taskmanager_user.profImg as user_prof, 
taskmanager_taskcolor.color as user_color,

taskmanager_tables.name as table_name ,
taskmanager_tables.url as table_url,
taskmanager_tables.color as table_color
from 
taskmanager_taskcolor 
join taskmanager_tables ON tableId_id = taskmanager_tables.id 
join taskmanager_user  on userId_id = taskmanager_user.id 


insert into taskmanager_user (name, password, profImg, singupDate) values
("admin", "password", "/img/profile.png","datetime('now')");
insert into taskmanager_user (name, password, profImg, singupDate) values
("janusz", "password", "/img/profile.png","datetime('now')");
insert into taskmanager_user (name, password, profImg, singupDate) values
("testuser", "password", "/img/profile.png","datetime('now')");


insert into taskmanager_user (name, password, profImg, singupDate) values
("guest", "guest", "/img/profile.png","datetime('now')");






select 
* 
from 
get_tasks
WHERE table_name IS NOT NULL 
AND added_date IS NOT NULL 
AND strftime('%%Y-%%m-%%d', to_do_date) >= date("2021-10-01")
AND strftime('%%Y-%%m-%%d', to_do_date) <= date("2021-10-31")
AND table_url = "eulmefqhqndhiviv"
GROUP BY user_id, table_url, note_id
ORDER BY to_do_date ASC



select 
taskmanager_table.id as id,
tableNote
FROM
taskmanager_notes
JOIN taskmanager_user ON taskmanager_notes.userId_id = taskmanager_user.id
JOIN taskmanager_tables ON taskmanager_notes.tableId_id = taskmanager_tables.id
JOIN taskmanager_particip ON taskmanager_notes.userId_id = taskmanager_particip.userId_id
join get_table_color on taskmanager_user.name = get_table_color.user_name
where table_url = "ocrjjusneaoeqdtf"
group by user_name
;

WHERE table_name IS NOT NULL 
AND added_date IS NOT NULL 
AND strftime('%Y-%m-%d', to_do_date) >= date("2021-%s-01")
AND strftime('%Y-%m-%d', to_do_date) <= date("2021-%s-31")
AND table_url = "%s"
GROUP BY user_id, table_url, note_id
ORDER BY to_do_date ASC










select * 
from 
get_tasks_info
WHERE table_name IS NOT NULL 
AND added_date IS NOT NULL 

AND strftime('%Y-%m-%d', to_do_date) >= date("2021-07-01")
AND strftime('%Y-%m-%d', to_do_date) <= date("2021-07-31")
ORDER BY to_do_date ASC
;


GROUP BY note;
ORDER BY todoDate ASC;

select * from get_tasks_info
GROUP BY user_id, table_url, note_id
ORDER BY todoDate ASC;





WHERE table_name IS NOT NULL 
AND addedDate IS NOT NULL 
AND strftime('%Y-%m-%d', todoDate) >= date("2021-08-01")
AND strftime('%Y-%m-%d', todoDate) <= date("2021-08-31")
AND table_url = "%s"


select 
* 
from 
get_tasks_info
WHERE table_name IS NOT NULL 
AND added_date IS NOT NULL 
AND strftime('%Y-%m-%d', to_do_date) >= date("%s-01-01")
AND strftime('%Y-%m-%d', to_do_date) <= date("%s-12-31")
AND table_url = "ocrjjusneaoeqdtf"
ORDER BY to_do_date ASC
;



into taskmanager_particip (tableId_id, userId_id, color_id. dateJoined) 
values (
(select id from taskmanager_tables where url = 'gktvnrscnsurgzhu'),
(select id from taskmanager_user where name = 'admin'),
(select id from taskmanager_taskcolor where userId_id = (
select id from taskmanager_user where name = 'admin')),
datetime("now")
);



/*taking user from one group*/

SELECT
		 taskmanager_user.name as user,
		 taskmanager_tables.name as table_name,
		 taskmanager_tables.url as table_url,
		 taskmanager_tables.color as table_color,
		 taskmanager_tables.borderColor as table_b_color
		 FROM
		 taskmanager_particip
		 LEFT JOIN taskmanager_user ON taskmanager_particip.userId_id = taskmanager_user.id
		 LEFT JOIN taskmanager_tables ON taskmanager_particip.tableId_id = taskmanager_tables.id

		 WHERE 
		 table_name IS NOT NULL
		 GROUP BY table_name
		 ORDER BY taskmanager_tables.id DESC

lol = cursor.execute('''

     SELECT
     id, 
     taskmanager_user.id as user_id,
     taskmanager_tables.id as table_id,
     taskmanager_user.name,
     taskmanager_tables.name
     FROM
     taskmanager_particip
     LEFT JOIN taskmanager_user ON taskmanager_particip.userId_id = taskmanager_user.id
     LEFT JOIN taskmanager_tables ON taskmanager_particip.tableId_id = taskmanager_tables.id
     WHERE
     taskmanager_tables.name = "maintable";
     ''')
for elem in lol: print(elem)

SELECT name FROM pragma_table_info('taskmanager_user') JOIN (SELECT COUNT(*) FROM taskmanager_user);


SELECT
 taskmanager_user.name,
 taskmanager_tables.name
 FROM
 taskmanager_particip
 LEFT JOIN taskmanager_user ON taskmanager_particip.userId_id = taskmanager_user.id
 LEFT JOIN taskmanager_tables ON taskmanager_particip.tableId_id = taskmanager_tables.id
 
 cursor.execute('''SELECT * 
			SELECT name FROM pragma_table_info('%s') 
			JOIN (SELECT COUNT(*) 
			FROM %s);
			'''% ("taskmanager_user", "taskmanager_user"))


#list columns
SELECT name FROM pragma_table_info('taskmanager_user') JOIN (SELECT COUNT(*) FROM taskmanager_user);

## inserting new table to user
insert into taskmanager_particip (tableId_id, userId_id) values (
(select id from taskmanager_tables where name = 'maintable'),
(select id from taskmanager_user where name = 'adam')
);



#get users via table
SELECT
 taskmanager_user.name as user,
 taskmanager_tables.name as tablename
 FROM
 taskmanager_particip
 LEFT JOIN taskmanager_user ON taskmanager_particip.userId_id = taskmanager_user.id
 LEFT JOIN taskmanager_tables ON taskmanager_particip.tableId_id = taskmanager_tables.id
 WHERE taskmanager_tables.name = "maintable"
 WHERE tablename IS NOT NULL
 GROUP BY user
 ;


INSERT 
into taskmanager_particip (tableId_id, userId_id) 
values (
(select id from taskmanager_tables where name = ''),
(select id from taskmanager_user where name = '%s')
);

/*
*
*
*	*	*	*	*	*	*	**	*	*	*	*	*	*	**	*	*	*	*	*	*	**	*	*	*	*	*	*	**	*	*	*	*	*	*	*
*
*
*/
/*---------main page*/
list all tables with userid
user.name.
user.profile_pic
table.name
table.url
table.color
table.borderColor

/*_______ views*/

create view main_page_info as
SELECT
	 taskmanager_user.name as user,
	 taskmanager_user.profImg as prof_pic,
	 taskmanager_tables.id as table_id,
	 taskmanager_tables.name as table_name,
	 taskmanager_tables.url as table_url,
	 taskmanager_tables.color as table_color,
	 taskmanager_tables.borderColor as table_b_color
	 
	 FROM
	 taskmanager_particip
	 LEFT JOIN taskmanager_user ON taskmanager_particip.userId_id = taskmanager_user.id
	 LEFT JOIN taskmanager_tables ON taskmanager_particip.tableId_id = taskmanager_tables.id;

/*_______ queries*/
select * from main_page_info
	 WHERE user = "admin" AND
	 table_name IS NOT NULL
	 GROUP BY table_name
	 ORDER BY table_id DESC

/**/
/**/
/*_____create_table_______________________________________--*/
just inserting data
	
/*create new table*/
	insert into
	   taskmanager_tables (name, url, color, borderColor, password) 
	values
	   (
	      "%s", "%s", "%s", "%s","%s"
	   ) % (name, url, color, self.makeBorderColor(color), password))



INSERT 
into taskmanager_particip (tableId_id, userId_id, color_id) 
values (
(select id from taskmanager_tables where url = 'awexhhaebbedzwbi'),
(select id from taskmanager_user where name = 'admin'),
(select id from taskmanager_taskcolor where userId_id = (
select id from taskmanager_user where name = 'admin'))
);


		/*add new table to user*/
			INSERT 
			into taskmanager_particip (tableId_id, userId_id) 
			values (
			(select id from taskmanager_tables where url = '%s'),
			(select id from taskmanager_user where name = '%s')
			);
			 %  (url, user)


/**/
/**/
/**/
/* _____  tables*/

/*get user info*/
SELECT name FROM pragma_table_info('list_users_table') JOIN (SELECT COUNT(*) FROM list_users_table);

CREATE VIEW list_users_table as
SELECT 
taskmanager_user.id as user_id,
taskmanager_user.name as user_name,
taskmanager_user.profImg as user_prof,
taskmanager_taskcolor.color as user_color,
taskmanager_tables.id as table_id,
taskmanager_tables.url as table_url,
taskmanager_tables.name as table_name
FROM
taskmanager_particip
LEFT JOIN taskmanager_user ON taskmanager_particip.userId_id = user_id
LEFT JOIN taskmanager_tables ON taskmanager_particip.tableId_id = table_id
LEFT JOIN taskmanager_taskcolor ON taskmanager_taskcolor.color = user_color


/*get al tasks*/
create view  get_tasks as

SELECT
taskmanager_tables.name  as table_name,
taskmanager_user.name  as user,
taskmanager_user.id  as user_id,
taskmanager_user.profImg  as user_prof_pic,
taskmanager_tables.color as table_color,
taskmanager_tables.url as table_url,
taskmanager_particip.color as user_color,
taskmanager_notes.id as note_id,
taskmanager_notes.tableNote as note,
taskmanager_notes.todoDate as to_do_date,
taskmanager_notes.addedDate as added_date
FROM
taskmanager_notes
JOIN taskmanager_user ON taskmanager_notes.userId_id = taskmanager_user.id
JOIN taskmanager_tables ON taskmanager_notes.tableId_id = taskmanager_tables.id
JOIN taskmanager_particip ON taskmanager_notes.userId_id = taskmanager_particip.userId_id

select * from get_tasks
WHERE table_name IS NOT NULL AND
added_date IS NOT NULL
;
   RESULTSS
   [('testing1', 'admin', '/static/img/profile.png', '#cfc196', '#ff0000', 'testing note', datetime.datetime(2021, 1, 1, 14, 0), datetime.datetime(2021, 7, 17, 12, 2, 26, 316721)), ('testing1', 'admin', '/static/img/profile.png', '#cfc196', '#ff0000', 'testing note', datetime.datetime(2021, 2, 1, 20, 15), datetime.datetime(2021, 7, 17, 12, 11, 25, 62514)), ('testing1', 'admin', '/static/img/profile.png', '#cfc196', '#ff0000', 'testing note', datetime.datetime(2021, 7, 21, 20, 15), datetime.datetime(2021, 7, 17, 12, 12, 25, 250457)), ('testing1', 'admin', '/static/img/profile.png', '#cfc196', '#ff0000', 'testing note2', datetime.datetime(2021, 7, 21, 18, 15), datetime.datetime(2021, 7, 17, 12, 18, 38, 368471))]

SELECT name FROM pragma_table_info('get_tasks') JOIN (SELECT COUNT(*) FROM get_tasks);


/*get task by day*/
get note by day
select * from taskmanager_notes where strftime('%Y-%m-%d', todoDate) = date("2021-07-11");

/*insert to the task*/
insert into taskmanager_notes (tableNote, addedDate, todoDate, tableId_id, userId_id) 
	values("task note 2", datetime("now"), datetime("now","+2 hour"), 
		(select id from taskmanager_tables where url = "wmtjbjymmxjwqomj"),
		(select id from taskmanager_user where name = "janusz")
			);

user name / id
note
table url 


/*get all grouping */
select 
* 
from 
get_tasks
 WHERE table_name IS NOT NULL 
 AND added_date IS NOT NULL 
 AND strftime('%Y-%m-%d', to_do_date) = date("2021-07-18")
 GROUP BY note_id;

/*get all month*/
select 
* 
from 
get_tasks
 WHERE table_name IS NOT NULL 
 AND added_date IS NOT NULL 
 AND strftime('%Y-%m-%d', to_do_date) >= date("2021-07-01")
 AND strftime('%Y-%m-%d', to_do_date) <= date("2021-07-31")
 AND table_url = "wmtjbjymmxjwqomj"
			GROUP BY user_id, table_url, note_id
 ;




SELECT
taskmanager_tables.name  as table_name,
taskmanager_user.name  as user,
taskmanager_user.id  as user_id,
taskmanager_user.profImg  as user_prof_pic,
taskmanager_tables.color as table_color,
taskmanager_taskcolor.color as color,
taskmanager_tables.url as table_url,
taskmanager_particip.color_id as user_color,
taskmanager_notes.id as note_id,
taskmanager_notes.tableNote as note,
taskmanager_notes.todoDate as to_do_date,
taskmanager_notes.addedDate as added_date
FROM
taskmanager_notes
JOIN taskmanager_user ON taskmanager_notes.userId_id = taskmanager_user.id
JOIN taskmanager_tables ON taskmanager_notes.tableId_id = taskmanager_tables.id
JOIN taskmanager_particip ON taskmanager_notes.userId_id = taskmanager_particip.userId_id
JOIN taskmanager_taskcolor ON taskmanager_user.id = taskmanager_taskcolor.userId_id
;



WHERE table_name IS NOT NULL 
AND added_date IS NOT NULL 
AND strftime('%Y-%m-%d', to_do_date) = date("2021-07-18")
GROUP BY user_id, table_url, note_id;


select
* 
from 
taskmanager_taskcolor
 
join taskmanager_tables ON taskmanager_taskcolor.tableId_id = taskmanager_tables.id
join taskmanager_user ON taskmanager_taskcolor.userId_id = taskmanager_user.id;




/*create new user*/
insert into taskmanager_user (name, password, profImg, singupDate) values
("admin", "password", "/img/profile.png","datetime('now')");
insert into taskmanager_user (name, password, profImg, singupDate) values
("janusz", "password", "/img/profile.png","datetime('now')");
insert into taskmanager_user (name, password, profImg, singupDate) values
("testuser", "password", "/img/profile.png","datetime('now')");





CREATE TABLE IF NOT EXISTS "taskmanager_user" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "name" varchar(100) NOT NULL, "password" varchar(100) NOT NULL, "profImg" varchar(100) NOT NULL, "singupDate" datetime NOT NULL);
CREATE TABLE IF NOT EXISTS "taskmanager_tables" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "name" varchar(100) NOT NULL, "url" varchar(16) NOT NULL, "color" varchar(7) NOT NULL, "borderColor" varchar(7) NOT NULL, "password" varchar(200) NOT NULL);
CREATE TABLE IF NOT EXISTS "taskmanager_particip" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "tableId_id" bigint NOT NULL REFERENCES "taskmanager_tables" ("id") DEFERRABLE INITIALLY DEFERRED, "userId_id" bigint NOT NULL REFERENCES "taskmanager_user" ("id") DEFERRABLE INITIALLY DEFERRED, "color" varchar(7) NOT NULL);


CREATE VIEW main_page_info as
SELECT
	 taskmanager_user.name as user,
	 taskmanager_user.profImg as prof_pic,
	 taskmanager_tables.id as table_id,
	 taskmanager_tables.name as table_name,
	 taskmanager_tables.url as table_url,
	 taskmanager_tables.color as table_color,
	 taskmanager_tables.borderColor as table_b_color
	 
	 FROM
	 taskmanager_particip
	 LEFT JOIN taskmanager_user ON taskmanager_particip.userId_id = taskmanager_user.id
	 LEFT JOIN taskmanager_tables ON taskmanager_particip.tableId_id = taskmanager_tables.id
/* main_page_info(user,prof_pic,table_id,table_name,table_url,table_color,table_b_color) */;



DELETE 
FROM 
taskmanager_particip
WHERE 
id =
(SELECT 
id
FROM 
taskmanager_tables
WHERE
url = 'wnvnxfkrrcwtfslw'
)

lvrxshepaiqitamh

INSERT 
into taskmanager_particip (tableId_id, userId_id, color) 
values (
(select id from taskmanager_tables where url = 'ktvhwbbvurrotfuz'),
(select id from taskmanager_user where name = 'admin'),
"%s"
);

select * from get_tasks
 WHERE table_url = "lvrxshepaiqitamh" AND
 table_name IS NOT NULL
 ;

INSERT 
into taskmanager_particip (tableId_id, userId_id, color) 
values (
(select id from taskmanager_tables where url = 'lvrxshepaiqitamh'),
(select id from taskmanager_user where name = 'admin'),
"%s"
),
WHERE NOT EXISTS(
select 
1
from taskmanager_particip 
LEFT JOIN taskmanager_user ON taskmanager_particip.userId_id = taskmanager_user.id
LEFT JOIN taskmanager_tables ON taskmanager_particip.tableId_id = taskmanager_tables.id
Where taskmanager_user.name = "admin" AND taskmanager_tables.url = "lvrxshepaiqitamh"
);

;

WHERE NOT EXISTS(SELECT 1 FROM memos WHERE id = 5 AND text = 'text to insert');

;